spring.application.name=purchase-transaction-app
server.port=8080
# Allow test configurations to override production beans (needed for integration tests)
spring.main.allow-bean-definition-overriding=true
logging.level.root=INFO
logging.level.com.purchase.transaction=DEBUG
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.time-zone=UTC
app.repository.path=./data
app.exchange-rate.cache-enabled=true
app.exchange-rate.url=https://api.fiscaldata.treasury.gov/services/api/fiscal_service/v1/accounting/od/rates_of_exchange

# ==============================================================================
# RESILIENCE4J CONFIGURATION - Circuit Breaker, Bulkhead, Retry, Time Limiter
# ==============================================================================

# ------------------------------------------------------------------------------
# CIRCUIT BREAKER PATTERN: Prevents cascading failures by stopping calls to 
# failing services and providing fast failure responses
# ------------------------------------------------------------------------------
# Instance name: treasuryApi (used in @CircuitBreaker annotation)
# Sliding window size: Number of calls to track for failure rate calculation
resilience4j.circuitbreaker.instances.treasuryApi.slidingWindowSize=10

# Failure rate threshold: Circuit opens when failure rate exceeds 50%
resilience4j.circuitbreaker.instances.treasuryApi.failureRateThreshold=50

# Wait duration in open state: How long to wait before trying again (30 seconds)
resilience4j.circuitbreaker.instances.treasuryApi.waitDurationInOpenState=30s

# Half-open state: Number of test calls to determine if service recovered
resilience4j.circuitbreaker.instances.treasuryApi.permittedNumberOfCallsInHalfOpenState=3

# Sliding window type: Count-based (alternative: time-based)
resilience4j.circuitbreaker.instances.treasuryApi.slidingWindowType=COUNT_BASED

# Minimum number of calls before calculating failure rate
resilience4j.circuitbreaker.instances.treasuryApi.minimumNumberOfCalls=5

# ------------------------------------------------------------------------------
# BULKHEAD PATTERN: Limits concurrent calls to prevent resource exhaustion
# This works in conjunction with connection pool limits in RestTemplateConfig
# ------------------------------------------------------------------------------
# Maximum concurrent calls: Limit to 10 simultaneous calls to Treasury API
# This prevents the Treasury API integration from consuming all application threads
resilience4j.bulkhead.instances.treasuryApi.maxConcurrentCalls=10

# Max wait duration: How long to wait for permission to make a call (500ms)
# If bulkhead is full, caller waits up to 500ms before getting rejected
resilience4j.bulkhead.instances.treasuryApi.maxWaitDuration=500ms

# ------------------------------------------------------------------------------
# RETRY PATTERN: Automatically retries failed calls with exponential backoff
# Useful for transient failures (network hiccups, temporary service unavailability)
# ------------------------------------------------------------------------------
# Maximum retry attempts: Try up to 3 times before giving up
resilience4j.retry.instances.treasuryApi.maxAttempts=3

# Initial wait duration: Wait 2 seconds before first retry
resilience4j.retry.instances.treasuryApi.waitDuration=2s

# Exponential backoff multiplier: Each retry waits 2x longer (2s, 4s, 8s)
resilience4j.retry.instances.treasuryApi.exponentialBackoffMultiplier=2

# Maximum wait duration: Cap retry wait time at 10 seconds
resilience4j.retry.instances.treasuryApi.exponentialMaxWaitDuration=10s

# Retry only on exceptions (not on certain HTTP status codes)
resilience4j.retry.instances.treasuryApi.retryExceptions=java.net.SocketTimeoutException,java.io.IOException

# ------------------------------------------------------------------------------
# TIME LIMITER PATTERN: Prevents calls from hanging indefinitely
# Works with @TimeLimiter annotation to enforce call timeout
# ------------------------------------------------------------------------------
# Timeout duration: Cancel call if it takes longer than 10 seconds
resilience4j.timelimiter.instances.treasuryApi.timeoutDuration=10s

# Cancel running future on timeout (for async calls)
resilience4j.timelimiter.instances.treasuryApi.cancelRunningFuture=true

# ------------------------------------------------------------------------------
# RATE LIMITER PATTERN: Prevents overwhelming external services
# Limits the rate of calls within a time period
# ------------------------------------------------------------------------------
# Limit for period: Allow maximum 50 calls per refresh period
resilience4j.ratelimiter.instances.treasuryApi.limitForPeriod=50

# Limit refresh period: Refresh the limit every 1 second
resilience4j.ratelimiter.instances.treasuryApi.limitRefreshPeriod=1s

# Timeout: Don't wait if rate limit exceeded, fail immediately
resilience4j.ratelimiter.instances.treasuryApi.timeoutDuration=0s

# ==============================================================================
# SPRING BOOT ACTUATOR CONFIGURATION - Health Checks & Monitoring
# ==============================================================================

# Expose actuator endpoints for monitoring and health checks
# Available at: http://localhost:8080/actuator/*
management.endpoints.web.exposure.include=health,metrics,info,circuitbreakers,circuitbreakerevents,ratelimiters,bulkheads

# Show detailed health information (including circuit breaker states)
management.endpoint.health.show-details=always

# Enable circuit breaker health indicator
management.health.circuitbreakers.enabled=true

# Enable rate limiter health indicator
management.health.ratelimiters.enabled=true

# Actuator base path (default is /actuator)
management.endpoints.web.base-path=/actuator

# Enable metrics export
management.metrics.export.simple.enabled=true

# ==============================================================================
# HEALTH CHECK ENDPOINTS:
# - /actuator/health - Overall application health
# - /actuator/health/circuitBreakers - Circuit breaker states
# - /actuator/metrics - Application metrics
# - /actuator/circuitbreakers - Circuit breaker details
# - /actuator/circuitbreakerevents - Recent circuit breaker events
# - /actuator/bulkheads - Bulkhead states
# - /actuator/ratelimiters - Rate limiter states
# ==============================================================================
